!function(){var e={url:"http://127.0.0.1:5000",version:"1.0",channel:"mine",heartTime:5e3},n=window.proto,s={};window.net=s,s.config=e,s.time=n.ServerTime.create(),s.login_id=0;var t=function(){return new Date/1e3},o=function(e){e+="?";for(var n=1;n<arguments.length;n++){var s=arguments[n];for(var t in s)e+=t+"="+(null==s[t]?"":s[t])+"&"}return e.substr(0,e.length-1)},i=function(){function TypedSignalHandler(e,n,s){void 0===s&&(s=!1),this._handler=e,this._self=n,this._once=s}return TypedSignalHandler.prototype.apply=function(e){this._handler.apply(this._self,[e])},TypedSignalHandler.prototype.equals=function(e,n){return this._handler==e&&this._self==n},TypedSignalHandler.prototype.once=function(){return this._once},TypedSignalHandler}(),r=function(){function TypedSignal(){this._listeners=[]}return TypedSignal.prototype.on=function(e,n){this.hasListener(e,n)||this._listeners.push(new i(e,n))},TypedSignal.prototype.onOnce=function(e,n){this.hasListener(e,n)||this._listeners.push(new i(e,n,!0))},TypedSignal.prototype.hasListener=function(e,n){for(var s=0;s<this._listeners.length;s++)if(this._listeners[s].equals(e,n))return!0;return!1},TypedSignal.prototype.off=function(e,n){for(var s=0;s<this._listeners.length;s++)if(this._listeners[s].equals(e,n)){this._listeners.splice(s,1);break}},TypedSignal.prototype.clear=function(){this._listeners.length=0},TypedSignal.prototype.emit=function(e){this._listeners.forEach(function(n){return n.apply(e)}),this._listeners=this._listeners.filter(function(e,n,s){return!e.once()})},TypedSignal}(),a=function(n,s){var t=new XMLHttpRequest,o={error:45,errstr:"http net failed"};t.onreadystatechange=function(){var e=4==t.readyState&&t.status>=200&&t.status<400;e?(e=0==(o=JSON.parse(t.responseText)).error,null!=s&&s(e,o,t)):4==t.readyState&&s(!1,o)},t.open("GET",encodeURI(e.url+n),!0),t.send()},l={ServerTimeS2C:!0,ServerTimeC2S:!0,GamerPVPSyncC2S:!0,GamerNotifyPVPSyncS2C:!0};s.C2S=function(e,t){var o=(r=n).C2S.create(),i=e.substring(0,1).toLowerCase()+e.substring(1),r=r[e].create();if(o[i]=r,"GamerPVPSyncC2S"!=e&&"GamerPVPLoadingC2S"!=e||(o.key=t.session),r.id=s.login_id,r.send=function(){if(net.logic._ws){if(net.logic._ws.readyState>1)return void console.error("*************** 网络断开了 c->s: "+e+"  args: ",t);if(0==net.logic._ws.readyState)return void console.error("*************** 网络正在连接中 不能发生消息 c->s: "+e+"  args: ",t)}l[e]||console.log("***************c->s: "+e+"  args: ",t);var i=n.C2S.encode(o).finish();s.logic._ws.send(i.buffer.slice(i.byteOffset,i.byteOffset+i.byteLength))},null==t)return r;for(var a in t)r[a]=t[a];r.send()},s._EventDispatch=r;var c=function(e){var o=n.S2C.decode(e);if(""==o.key)for(var i in s.logic)if(null!=o[i]){o.key=i;break}if(""!=o.key){var r=o.key.substring(0,1).toUpperCase()+o.key.substring(1);o.key=o.key.substring(0,1).toLowerCase()+o.key.substring(1);var a=o[o.key];if(0==a.error&&("gamerLoginS2C"==o.key?s.logic._session=a.main.session:"serverTimeS2C"==o.key||"gamerLoginGetDataS2C"==o.key?(s.time=a.time,"serverTimeS2C"==o.key&&(s.logic.ping=Math.round(1e3*(t()-s.logic._lastPingSend)))):"gamerNotifyLoginOtherS2C"==o.key&&(s.logic._session="")),l[r]||console.log("***************s->c: "+o.key+JSON.stringify(a)),0==o.error){var c=Game.protoHandler[r];void 0!==c&&null!=c&&c(a)}var d=s.logic[o.key];void 0!==d&&null!=d&&d.emit(a)}o.error>0&&(2001!=o.error&&2003!=o.error&&2004!=o.error||(s.logic._session=""),s.logic.onError.emit(o.error))};s.auth={config:function(e){a(o("/config"),e)},register:function(e,n,s){a(o("/register",{channel:"mine",name:e,passwd:n}),s)},login:function(n,s,t){a(o("/login",{channel:e.channel,name:n,passwd:s}),t)},newRole:function(e,n,s,t,i,r){a(o("/newrole",{session:e,name:n,type:s,server:t,avatar:i}),r)},useRole:function(n,t,i){s.login_id=t,s.logic._session="",a(o("/userole",{session:n,id:t}),function(n,t,o){n&&(s.logic._compress=t.server.compress,0==e.url.indexOf("http://")?s.logic._addr=e.url.replace("http:","ws:")+"/proxy":0==e.url.indexOf("https://")&&(s.logic._addr=e.url.replace("https:","wss:")+"/proxy")),i(n,t,o)})},fastLogin:function(n,t,i,r){a(o("/fastlogin",{name:n,channel:t,openid:i}),function(n,t,o){n&&(s.login_id=t.roleId,s.logic._session="",s.logic._compress=t.server.compress,0==e.url.indexOf("http://")?s.logic._addr=e.url.replace("http:","ws:")+"/proxy":0==e.url.indexOf("https://")&&(s.logic._addr=e.url.replace("https:","wss:")+"/proxy")),r(n,t,o)})},newAndUseRole:function(e,n,s,t,o,i){var r=this;this.newRole(e,n,s,t,o,function(e,n){e?r.useRole(n.session,n.roles[0].id,i):i(e,n)})},mineLogin:function(e,n,s,t,o,i){var r=this;r.login(e,n,function(a,l){a?null==l.roles?r.newAndUseRole(l.session,s,t,o,"",i):r.useRole(l.session,l.roles[0].id,i):45==l.error?i(a,l):r.register(e,n,function(n,s){n?r.newAndUseRole(s.session,e,t,o,"",i):i(n,s)})})},sdkLogin:function(e,n,s,t,o,i,r){var a=this;a.login(e,n,function(e,n){e?null==n.roles?a.newAndUseRole(n.session,s,t,o,i,r):a.useRole(n.session,n.roles[0].id,r):r(e,n)})}},s.logic={_addr:"",_ws:null,_session:"",_lastConnect:0,_heart:null,_compress:!1,_lastPingSend:0,ping:50,connect:function(n){this._lastConnect=t(),null!=n&&(this._addr=n),console.log("connect to addr:",this._addr," session:",this._session),null!=this._ws&&(this._ws.onerror=function(){},this._ws.onclose=function(){},this._ws.close(),this._ws=null);var o=function(){clearInterval(this._heart),this._heart=setInterval(function(){this.serverTimeC2S(),this._lastPingSend=t()}.bind(this),e.heartTime),this.gamerLoginC2S(this._session),console.log("connect to addr:",this._addr," ok session:",this._session),this.onConnect.emit()}.bind(this),i=function(e){console.log("onclose",e),clearInterval(this._heart),console.log("reconnect to addr:",this._addr," session:",this._session),""==this._addr||""==this._session?this.onClose.emit():(this.onReconnect.emit(),t()-this._lastConnect>=1&&this.connect(),this._heart=setInterval(function(){this.onReconnect.emit(),this.connect()}.bind(this),1e3))}.bind(this),r=function(e){console.log("onerror",e),i()}.bind(this);this._ws=new WebSocket(this._addr),this._ws.binaryType="arraybuffer",this._ws.onopen=o,this._ws.onmessage=function(e){if(e.data instanceof ArrayBuffer){var n=new Uint8Array(e.data,e.data.byteOffset,e.data.byteLength);c(s.logic._compress?pako.inflate(n):n)}else if(e.data instanceof Blob){var t=new FileReader;t.readAsArrayBuffer(e.data),t.onload=function(e){if(e.target.readyState==FileReader.DONE){var n=new Uint8Array(e.target.result);c(s.logic._compress?pako.inflate(n):n)}}}},this._ws.onerror=r,this._ws.onclose=i},onError:new r,onConnect:new r,onClose:new r,onReconnect:new r}}();var protoSources={};for(var key in window.protoSources=protoSources,proto)protoSources[key]=proto[key];